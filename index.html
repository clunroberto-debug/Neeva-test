<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Neeva – Combat Base</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #111827;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 10px 16px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header small {
      color: #9ca3af;
    }
    main {
      padding: 12px;
      display: grid;
      grid-template-columns: 1.3fr 0.7fr;
      gap: 12px;
    }
    .column {
      background: #020617;
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #1f2937;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      border-bottom: 1px solid #1f2937;
      padding-bottom: 4px;
    }
    .team {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .char-card {
      background: #111827;
      border-radius: 6px;
      padding: 6px;
      border: 1px solid #374151;
      width: 170px;
      cursor: pointer;
    }
    .char-card.enemy {
      border-color: #7f1d1d;
    }
    .char-card.selected {
      box-shadow: 0 0 0 2px #facc15;
    }
    .char-card.target {
      box-shadow: 0 0 0 2px #38bdf8;
    }
    .char-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
    }
    .hp-bar {
      height: 6px;
      background: #1f2937;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 4px;
    }
    .hp-fill {
      height: 100%;
      background: #22c55e;
    }
    .stat-line {
      font-size: 11px;
      color: #9ca3af;
      line-height: 1.3;
    }
    .controls {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    button {
      background: #1d4ed8;
      border: none;
      color: white;
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    button.secondary {
      background: #374151;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .log {
      font-size: 11px;
      max-height: 320px;
      overflow-y: auto;
      background: #020617;
      border-radius: 6px;
      border: 1px solid #1f2937;
      padding: 6px;
      white-space: pre-line;
    }
    .log-line {
      margin-bottom: 2px;
    }
    .log-turn {
      color: #60a5fa;
      font-weight: 600;
    }
    .info-row {
      font-size: 12px;
      margin-bottom: 6px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Neeva — Combat Prototype</h1>
      <small>Base 3v3, turni globali, critici completi</small>
    </div>
    <div style="font-size:12px;color:#9ca3af">
      Turno globale: <strong><span id="turnNumber">1</span></strong> —
      Lato attivo: <strong><span id="currentSideLabel">Player</span></strong>
    </div>
  </header>

  <main>
    <!-- COLONNA SINISTRA: Campo -->
    <div class="column">
      <div class="section-title">Campo di Battaglia</div>

      <div class="info-row">
        Seleziona <strong>prima</strong> un tuo personaggio, poi un nemico, poi clicca
        <strong>Attacco base</strong>.
      </div>

      <div>
        <div style="font-size:12px;font-weight:600;margin-bottom:2px;">Il tuo team</div>
        <div class="team" id="playerTeam"></div>
      </div>

      <div>
        <div style="font-size:12px;font-weight:600;margin:6px 0 2px;">Team avversario</div>
        <div class="team" id="botTeam"></div>
      </div>

      <div class="controls">
        <button id="btnBaseAttack" disabled>Attacco base (PG selezionato → bersaglio selezionato)</button>
        <button id="btnEndPlayerTurn" class="secondary">Fine turno senza attaccare</button>
        <button id="btnResetSelection" class="secondary">Reset selezione</button>
      </div>
    </div>

    <!-- COLONNA DESTRA: Log -->
    <div class="column">
      <div class="section-title">Log di gioco</div>
      <div id="log" class="log"></div>
    </div>
  </main>

  <script>
    /****************************************************
     * MODELLO BASE
     ****************************************************/
    const gameState = {
      globalTurn: 1,          // 1 = player, 2 = bot, 3 = player, ...
      currentSide: "player",  // "player" | "bot"
      playerTeam: [],
      botTeam: [],
      selectedAttackerId: null,
      selectedTargetId: null
    };

    function createCharacter(id, name, side, stats) {
      return {
        id,
        name,
        side, // "player" | "bot"
        base: { ...stats },
        current: { ...stats },
        shield: 0,
        alive: true
      };
    }

    function initTeams() {
      // Qui ho messo le stat aggiornate che hai definito (o vicine)
      gameState.playerTeam = [
        createCharacter("basil", "Basil", "player", {
          lp: 980, lpMax: 980,
          atk: 63, def: 27,
          critChance: 60,   // %
          critDmg: 120,     // %
          critResist: 22,   // %
          critDef: 47       // valore piatto
        }),
        createCharacter("gael", "Gael", "player", {
          lp: 900, lpMax: 900,
          atk: 72, def: 11,
          critChance: 30,
          critDmg: 150,
          critResist: 10,
          critDef: 25
        }),
        createCharacter("zagrok", "Zagrok", "player", {
          lp: 830, lpMax: 830,
          atk: 68, def: 13,
          critChance: 30,
          critDmg: 150,
          critResist: 30,
          critDef: 20
        })
      ];

      gameState.botTeam = [
        createCharacter("mordel", "Mordel", "bot", {
          lp: 1020, lpMax: 1020,
          atk: 60, def: 32,
          critChance: 25,
          critDmg: 150,
          critResist: 25,
          critDef: 33
        }),
        createCharacter("kiddou", "Kiddou", "bot", {
          lp: 820, lpMax: 820,
          atk: 58, def: 23,
          critChance: 40,
          critDmg: 160,
          critResist: 20,
          critDef: 26
        }),
        createCharacter("rindu", "Rindu", "bot", {
          lp: 860, lpMax: 860,
          atk: 78, def: 28,
          critChance: 28,
          critDmg: 150,
          critResist: 20,
          critDef: 22
        })
      ];
    }

    /****************************************************
     * LOG
     ****************************************************/
    const logEl = document.getElementById("log");

    function logLine(text, isTurnHeader = false) {
      const div = document.createElement("div");
      div.className = "log-line" + (isTurnHeader ? " log-turn" : "");
      div.textContent = text;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    /****************************************************
     * FUNZIONI UTILI
     ****************************************************/
    function getTeam(side) {
      return side === "player" ? gameState.playerTeam : gameState.botTeam;
    }

    function getOpposingTeam(side) {
      return side === "player" ? gameState.botTeam : gameState.playerTeam;
    }

    function findCharById(id) {
      return (
        gameState.playerTeam.find(c => c.id === id) ||
        gameState.botTeam.find(c => c.id === id)
      );
    }

    /****************************************************
     * COMBATTIMENTO CON CRITICO
     ****************************************************/
    function baseAttack(attacker, target) {
      if (!attacker.alive || !target.alive) return 0;

      // 1) Calcolo se critico
      const effCritChance = Math.max(0, (attacker.current.critChance || 0) - (target.current.critResist || 0));
      const roll = Math.floor(Math.random() * 100) + 1; // 1-100
      const isCrit = roll <= effCritChance;

      let rawDamage;
      if (isCrit) {
        // ATK * (CritDmg%) - CritDef
        const critMultiplier = (attacker.current.critDmg || 100) / 100;
        rawDamage = Math.round(attacker.current.atk * critMultiplier);
        rawDamage -= (target.current.critDef || 0);
        logLine(`${attacker.name} colpisce CRITICO ${target.name}! (roll ${roll} ≤ ${effCritChance})`);
      } else {
        rawDamage = attacker.current.atk;
        logLine(`${attacker.name} attacca ${target.name} (roll ${roll} > ${effCritChance}, niente critico).`);
      }

      if (rawDamage < 0) rawDamage = 0;

      // 2) Scudo
      let remaining = rawDamage;
      if (target.shield > 0) {
        const absorbed = Math.min(target.shield, remaining);
        target.shield -= absorbed;
        remaining -= absorbed;
        logLine(`${target.name} assorbe ${absorbed} danni con lo Scudo.`);
      }

      if (remaining <= 0) {
        logLine(`Il colpo non supera lo scudo di ${target.name}.`);
        return 0;
      }

      // 3) Difesa
      const def = target.current.def || 0;
      const finalDamage = Math.max(0, remaining - def);

      if (finalDamage <= 0) {
        logLine(`La DIFESA di ${target.name} annulla il colpo.`);
        return 0;
      }

      // 4) Applica danno
      target.current.lp = Math.max(0, target.current.lp - finalDamage);
      logLine(`${attacker.name} infligge ${finalDamage} danni effettivi a ${target.name}. LP rimanenti: ${target.current.lp}/${target.current.lpMax}`);

      if (target.current.lp <= 0) {
        target.alive = false;
        logLine(`${target.name} è stato sconfitto!`);
      }

      return finalDamage;
    }

    /****************************************************
     * TURNI
     ****************************************************/
    function startGame() {
      initTeams();
      gameState.globalTurn = 1;
      gameState.currentSide = "player";
      gameState.selectedAttackerId = null;
      gameState.selectedTargetId = null;
      logEl.innerHTML = "";
      logLine("Inizio partita.");
      logLine(`— TURNO ${gameState.globalTurn} (Player) —`, true);
      render();
    }

    function endPlayerTurn() {
      // Controllo fine partita prima di far muovere il bot
      if (checkEndGame()) return;

      gameState.currentSide = "bot";
      gameState.globalTurn += 1;
      logLine("");
      logLine(`— TURNO ${gameState.globalTurn} (Bot) —`, true);
      render();
      botAct();
    }

    function botAct() {
      const aliveBot = gameState.botTeam.filter(c => c.alive);
      const alivePlayer = gameState.playerTeam.filter(c => c.alive);
      if (aliveBot.length === 0 || alivePlayer.length === 0) {
        checkEndGame();
        return;
      }
      const attacker = aliveBot[Math.floor(Math.random() * aliveBot.length)];
      const target = alivePlayer[Math.floor(Math.random() * alivePlayer.length)];

      logLine(`${attacker.name} (Bot) prepara un attacco base su ${target.name}.`);
      baseAttack(attacker, target);
      render();

      if (checkEndGame()) return;

      // Passa di nuovo al player
      gameState.currentSide = "player";
      gameState.globalTurn += 1;
      logLine("");
      logLine(`— TURNO ${gameState.globalTurn} (Player) —`, true);
      resetSelection();
      render();
    }

    function checkEndGame() {
      const playerAlive = gameState.playerTeam.some(c => c.alive);
      const botAlive = gameState.botTeam.some(c => c.alive);
      if (!playerAlive || !botAlive) {
        logLine("");
        if (playerAlive && !botAlive) {
          logLine("HAI VINTO!", true);
        } else if (!playerAlive && botAlive) {
          logLine("HAI PERSO!", true);
        } else {
          logLine("PAREGGIO: tutti i personaggi sono KO.", true);
        }
        return true;
      }
      return false;
    }

    /****************************************************
     * SELEZIONE ATTACCANTE / BERSAGLIO
     ****************************************************/
    function onCharacterClick(charId, side) {
      if (gameState.currentSide !== "player") return; // solo nel tuo turno

      const ch = findCharById(charId);
      if (!ch || !ch.alive) return;

      // Se clicchi un tuo PG → selezioni ATTACCANTE
      if (side === "player") {
        gameState.selectedAttackerId = ch.id;
        // se il bersaglio era dello stesso lato, lo deselezioniamo
        if (gameState.selectedTargetId && findCharById(gameState.selectedTargetId).side === "player") {
          gameState.selectedTargetId = null;
        }
      } else {
        // Se clicchi un nemico → selezioni BERSAGLIO
        gameState.selectedTargetId = ch.id;
      }

      updateAttackButtonState();
      render();
    }

    function updateAttackButtonState() {
      const btn = document.getElementById("btnBaseAttack");
      const attacker = gameState.selectedAttackerId ? findCharById(gameState.selectedAttackerId) : null;
      const target = gameState.selectedTargetId ? findCharById(gameState.selectedTargetId) : null;

      if (
        gameState.currentSide === "player" &&
        attacker && target &&
        attacker.side === "player" &&
        target.side === "bot" &&
        attacker.alive && target.alive
      ) {
        btn.disabled = false;
      } else {
        btn.disabled = true;
      }
    }

    function playerBaseAttack() {
      const attacker = findCharById(gameState.selectedAttackerId);
      const target = findCharById(gameState.selectedTargetId);
      if (!attacker || !target) return;
      if (!attacker.alive || !target.alive) return;

      baseAttack(attacker, target);
      render();
      if (checkEndGame()) return;

      // Dopo l'attacco, termina subito il turno del player (per ora)
      endPlayerTurn();
    }

    function resetSelection() {
      gameState.selectedAttackerId = null;
      gameState.selectedTargetId = null;
      updateAttackButtonState();
      render();
    }

    /****************************************************
     * RENDER
     ****************************************************/
    function render() {
      document.getElementById("turnNumber").textContent = gameState.globalTurn;
      document.getElementById("currentSideLabel").textContent =
        gameState.currentSide === "player" ? "Player" : "Bot";

      renderTeam("playerTeam", gameState.playerTeam, false);
      renderTeam("botTeam", gameState.botTeam, true);
    }

    function renderTeam(containerId, team, isEnemy) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      team.forEach(ch => {
        const div = document.createElement("div");
        div.className = "char-card" + (isEnemy ? " enemy" : "");

        if (ch.id === gameState.selectedAttackerId) {
          div.classList.add("selected");
        }
        if (ch.id === gameState.selectedTargetId) {
          div.classList.add("target");
        }

        const name = document.createElement("div");
        name.className = "char-name";
        name.textContent = ch.name + (ch.alive ? "" : " (KO)");
        div.appendChild(name);

        const hpBar = document.createElement("div");
        hpBar.className = "hp-bar";
        const hpFill = document.createElement("div");
        hpFill.className = "hp-fill";
        const ratio = ch.current.lp / ch.current.lpMax;
        hpFill.style.width = (Math.max(0, Math.min(1, ratio)) * 100) + "%";
        hpBar.appendChild(hpFill);
        div.appendChild(hpBar);

        const stat = document.createElement("div");
        stat.className = "stat-line";
        stat.innerHTML =
          `LP: ${ch.current.lp}/${ch.current.lpMax}<br>` +
          `ATK: ${ch.current.atk} — DEF: ${ch.current.def}<br>` +
          `Crit: ${ch.current.critChance}% / ${ch.current.critDmg}%<br>` +
          `CritResist: ${ch.current.critResist}% — CritDef: ${ch.current.critDef}`;
        div.appendChild(stat);

        div.addEventListener("click", () => onCharacterClick(ch.id, ch.side));
        container.appendChild(div);
      });
    }

    /****************************************************
     * EVENT LISTENERS
     ****************************************************/
    document.getElementById("btnBaseAttack").addEventListener("click", playerBaseAttack);
    document.getElementById("btnEndPlayerTurn").addEventListener("click", () => {
      if (gameState.currentSide !== "player") return;
      endPlayerTurn();
    });
    document.getElementById("btnResetSelection").addEventListener("click", resetSelection);

    /****************************************************
     * AVVIO
     ****************************************************/
    startGame();
  </script>
</body>
</html>
