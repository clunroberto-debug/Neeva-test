<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Neeva Test – Turni e Carte</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0b1020;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 10px 16px;
      background: #151a30;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 {
      font-size: 18px;
      margin: 0;
    }
    main {
      padding: 12px 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .board {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .panel {
      background: #151a30;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #222842;
      flex: 1 1 0;
      min-width: 260px;
    }
    .panel h2 {
      font-size: 14px;
      margin: 0 0 6px;
    }
    .stats {
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-line;
    }
    .hand {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .card {
      background: #222842;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid #333b66;
      max-width: 180px;
    }
    .card.selected {
      border-color: #ffd447;
      box-shadow: 0 0 8px rgba(255, 212, 71, 0.6);
    }
    .card-header {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .card-cost {
      font-size: 10px;
      opacity: 0.8;
    }
    .card-body {
      font-size: 10px;
      opacity: 0.9;
      margin-top: 2px;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
      align-items: center;
    }
    button {
      background: #3944bc;
      color: #f5f5f5;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    button.secondary {
      background: #333a5c;
    }
    button.danger {
      background: #b63b3b;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    select {
      background: #151a30;
      color: #f5f5f5;
      border-radius: 4px;
      border: 1px solid #333b66;
      padding: 3px 4px;
      font-size: 11px;
    }
    .log {
      font-size: 11px;
      max-height: 220px;
      overflow-y: auto;
      white-space: pre-line;
    }
    .mana-info {
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Neeva – Test Turni & Carte</h1>
    <div style="font-size:12px;">Prototipo offline</div>
  </header>
  <main>
    <div class="board">
      <div class="row">
        <div class="panel">
          <h2>Tu (Giocatore)</h2>
          <div id="playerStats" class="stats"></div>
        </div>
        <div class="panel">
          <h2>Bot</h2>
          <div id="botStats" class="stats"></div>
        </div>
      </div>

      <div class="row">
        <div class="panel">
          <h2>Le tue carte in mano</h2>
          <div class="mana-info" id="manaInfo"></div>
          <div class="controls">
            <button id="startTurnBtn">Inizia / Nuovo turno</button>
            <button id="resolveBtn">Risolvi turno</button>
            <button id="resetTurnBtn" class="secondary">Reset turno</button>
            <label style="font-size:11px;">Bersaglio:
              <select id="targetSelect">
                <option value="">-- scegli --</option>
                <option value="bot-front">Bot Front</option>
                <option value="bot-mid">Bot Mid</option>
                <option value="bot-back">Bot Back</option>
              </select>
            </label>
          </div>
          <div id="playerHand" class="hand"></div>
        </div>

        <div class="panel">
          <h2>Log</h2>
          <div id="log" class="log"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // -------------------------
    // Dati di base di esempio
    // -------------------------

    const basePlayerChars = [
      {
        id: 'basil',
        name: 'Basil',
        lp: 1000,
        atk: 70,
        def: 40,
        critChance: 0.2,
        critDmg: 1.5,
        buffs: [],
        debuffs: []
      },
      {
        id: 'gael',
        name: 'Gael',
        lp: 900,
        atk: 80,
        def: 25,
        critChance: 0.25,
        critDmg: 1.5,
        buffs: [],
        debuffs: []
      },
      {
        id: 'zagrok',
        name: 'Zagrok',
        lp: 950,
        atk: 75,
        def: 30,
        critChance: 0.2,
        critDmg: 1.5,
        buffs: [],
        debuffs: []
      }
    ];

    const baseBotChars = [
      {
        id: 'bot-front',
        name: 'Mordel (Bot Front)',
        lp: 1000,
        atk: 65,
        def: 35,
        critChance: 0.2,
        critDmg: 1.5,
        buffs: [],
        debuffs: []
      },
      {
        id: 'bot-mid',
        name: 'Kiddou (Bot Mid)',
        lp: 880,
        atk: 78,
        def: 22,
        critChance: 0.3,
        critDmg: 1.6,
        buffs: [],
        debuffs: []
      },
      {
        id: 'bot-back',
        name: 'Rindu (Bot Back)',
        lp: 920,
        atk: 82,
        def: 20,
        critChance: 0.28,
        critDmg: 1.6,
        buffs: [],
        debuffs: []
      }
    ];

    // Carte di esempio (nome PERSONAGGIO + nome carta)
    const allPlayerCards = [
      {
        id: 'basil-attack-1',
        owner: 'Basil',
        name: 'Basil – Colpo di Scisto',
        cost: 1,
        type: 'attack',
        aoe: false,
        vc: 0.4,
        text: 'Attacco singolo 40% ATK di Basil.'
      },
      {
        id: 'gael-attack-1',
        owner: 'Gael',
        name: 'Gael – Colpo di Guardia',
        cost: 1,
        type: 'attack',
        aoe: false,
        vc: 0.55,
        text: 'Attacco singolo 55% ATK di Gael.'
      },
      {
        id: 'zagrok-attack-1',
        owner: 'Zagrok',
        name: 'Zagrok – Morso Virale',
        cost: 1,
        type: 'attack',
        aoe: false,
        vc: 0.60,
        text: 'Attacco singolo 60% ATK di Zagrok.'
      },
      {
        id: 'basil-shield',
        owner: 'Basil',
        name: 'Basil – Muro di Scisti',
        cost: 2,
        type: 'buff',
        aoe: false,
        text: 'Dà scudo a un alleato pari al 15% LP di Basil.'
      },
      {
        id: 'gael-taunt',
        owner: 'Gael',
        name: 'Gael – Sfida del Guardiano',
        cost: 3,
        type: 'buff',
        aoe: true,
        text: 'Per 1 turno i nemici che attaccano ricevono danni di ritorno.'
      },
      {
        id: 'zagrok-heal',
        owner: 'Zagrok',
        name: 'Zagrok – Ringiovanimento',
        cost: 3,
        type: 'buff',
        aoe: true,
        text: 'Cura leggera AOE basata su LP max di Zagrok.'
      }
    ];

    // Per semplicità: deck = copie multiple delle stesse carte
    function buildPlayerDeck() {
      const deck = [];
      // 2 copie di ogni carta di esempio
      for (let i = 0; i < 2; i++) {
        allPlayerCards.forEach(c => deck.push({ ...c }));
      }
      return shuffle(deck);
    }

    // ------------- Stato globale -------------
    let playerChars;
    let botChars;
    let playerDeck;
    let playerHand;
    let playerDiscard;
    let currentMana;
    let maxManaPerTurn = 7;
    let turnNumber = 1;
    let manaAtTurnStart = 7;
    let selectedCardIds = [];

    // ------------- Utility -------------
    function shuffle(array) {
      const a = [...array];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function log(text) {
      const logEl = document.getElementById('log');
      logEl.textContent += text + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    function getCharById(list, id) {
      return list.find(c => c.id === id);
    }

    // ------------- Inizializzazione -------------
    function initGame() {
      playerChars = JSON.parse(JSON.stringify(basePlayerChars));
      botChars = JSON.parse(JSON.stringify(baseBotChars));
      playerDeck = buildPlayerDeck();
      playerHand = [];
      playerDiscard = [];
      currentMana = maxManaPerTurn;
      turnNumber = 1;
      manaAtTurnStart = maxManaPerTurn;
      selectedCardIds = [];
      document.getElementById('log').textContent = '';

      // Pesca iniziale 7 carte
      drawCards(7);
      renderAll();
      log('Nuova partita iniziata. Pescate 7 carte iniziali.');
    }

    // ------------- Pesca -------------
    function drawCards(n) {
      for (let i = 0; i < n; i++) {
        if (playerDeck.length === 0) break;
        const card = playerDeck.shift();
        playerHand.push(card);
      }
    }

    // ------------- Turno giocatore -------------
    function startPlayerTurn() {
      turnNumber++;
      selectedCardIds = [];
      // Recupera mana pieno
      currentMana = maxManaPerTurn;
      manaAtTurnStart = currentMana;
      // Pesca 3 carte
      drawCards(3);
      log(`\n--- INIZIO TUO TURNO ${turnNumber} ---`);
      log('Pescate 3 carte. Mana ripristinato a ' + currentMana + '.');
      renderAll();
    }

    function toggleCardSelection(cardId) {
      const card = playerHand.find(c => c.id === cardId);
      if (!card) return;
      // Solo controllo sul mana: non superare il mana disponibile
      const alreadySelected = selectedCardIds.includes(cardId);
      if (alreadySelected) {
        // desseleziono
        selectedCardIds = selectedCardIds.filter(id => id !== cardId);
      } else {
        const totalCost = selectedCardIds
          .map(id => playerHand.find(c => c.id === id)?.cost ?? 0)
          .reduce((a, b) => a + b, 0);
        if (totalCost + card.cost > manaAtTurnStart) {
          log('Non puoi selezionare altre carte: supereresti il mana di inizio turno.');
          return;
        }
        selectedCardIds.push(cardId);
      }
      renderHand();
      renderMana();
    }

    function resetTurnSelection() {
      selectedCardIds = [];
      currentMana = manaAtTurnStart;
      document.getElementById('targetSelect').value = '';
      log('Selezione del turno resettata.');
      renderAll();
    }

    function resolveTurn() {
      if (selectedCardIds.length === 0) {
        log('Nessuna carta selezionata da giocare.');
        return;
      }

      // Controllo bersaglio per carte non AOE
      const targetSelect = document.getElementById('targetSelect');
      const targetId = targetSelect.value || null;

      // Controllo che tutte le carte non AOE abbiano un target
      const nonAoeSelected = selectedCardIds
        .map(id => playerHand.find(c => c.id === id))
        .filter(c => c && !c.aoe);

      if (nonAoeSelected.length > 0 && !targetId) {
        log('Devi selezionare un bersaglio per le carte non AOE.');
        return;
      }

      // Controllo mana totale
      const totalCost = selectedCardIds
        .map(id => playerHand.find(c => c.id === id)?.cost ?? 0)
        .reduce((a, b) => a + b, 0);

      if (totalCost > currentMana) {
        log('Mana insufficiente per risolvere tutte le carte selezionate.');
        return;
      }

      currentMana -= totalCost;

      // Applico le carte nell’ordine in cui sono in selectedCardIds
      for (const id of selectedCardIds) {
        const cardIndex = playerHand.findIndex(c => c.id === id);
        if (cardIndex === -1) continue;
        const card = playerHand[cardIndex];
        applyPlayerCard(card, targetId);
        // Sposto la carta nel cimitero
        playerDiscard.push(card);
        playerHand.splice(cardIndex, 1);
      }

      selectedCardIds = [];
      renderAll();

      // Dopo la risoluzione del tuo turno, tocca al bot
      botTurn();
      // Poi nuovo turno tuo
      startPlayerTurn();
    }

    // ------------- Effetti carte giocatore -------------
    function applyPlayerCard(card, targetId) {
      log(`Usi carta: ${card.name}`);
      const ownerChar = playerChars.find(c => c.name === card.owner);
      if (!ownerChar) {
        log('  [ERRORE] Nessun personaggio trovato per ' + card.owner);
        return;
      }

      if (card.type === 'attack') {
        if (card.aoe) {
          // Non usato in questo esempio, ma potrebbe essere AOE su tutti i bot
          botChars.forEach(botChar => {
            dealDamage(ownerChar, botChar, card.vc);
          });
        } else {
          const target = getCharById(botChars, targetId);
          if (!target) {
            log('  Nessun bersaglio valido selezionato.');
            return;
          }
          dealDamage(ownerChar, target, card.vc);
        }
      } else if (card.type === 'buff') {
        // Effetti semplificati per il prototipo
        if (card.id === 'basil-shield') {
          // Scudo su un alleato a scelta? Per ora lo mettiamo su Zagrok
          const ally = playerChars.find(c => c.id === 'zagrok') || playerChars[0];
          const shieldValue = Math.round(basePlayerChars[0].lp * 0.15);
          if (!ally.buffs) ally.buffs = [];
          ally.buffs.push({ type: 'shield', value: shieldValue, turns: 2 });
          log(`  ${ally.name} ottiene uno scudo di ${shieldValue} (2 turni).`);
        } else if (card.id === 'gael-taunt') {
          // Semplice logica: nessun effetto numerico, solo flavor
          log('  Per 1 turno: chi attacca i tuoi alleati subisce danni di ritorno (non completamente implementato).');
        } else if (card.id === 'zagrok-heal') {
          // Cura semplice a tutti basata su LP max di Zagrok
          const zagrokBase = basePlayerChars.find(c => c.id === 'zagrok');
          const amount = Math.round(zagrokBase.lp * 0.12);
          playerChars.forEach(ch => {
            ch.lp = Math.min(ch.lp + amount, zagrokBase.lp + 200); // limite random
          });
          log(`  Tutti i tuoi alleati guariscono di circa ${amount} LP.`);
        }
      }
    }

    function dealDamage(attacker, defender, vc) {
      const raw = Math.round(attacker.atk * vc);
      const dmg = Math.max(0, raw - defender.def);
      defender.lp = Math.max(0, defender.lp - dmg);
      log(`  ${attacker.name} infligge ${dmg} danni a ${defender.name} (${defender.lp} LP rimasti).`);
    }

    // ------------- Turno Bot (molto semplice) -------------
    function botTurn() {
      log('\n--- TURNO BOT ---');
      // Bot: cerca un giocatore vivo, infligge danno base col personaggio mid
      const botAttacker = botChars[1]; // Kiddou
      if (!botAttacker || botAttacker.lp <= 0) {
        log('  Il bot non può attaccare.');
        return;
      }
      const target = playerChars.find(c => c.lp > 0);
      if (!target) {
        log('  Il bot non trova bersagli (hai vinto).');
        return;
      }
      const vc = 0.5;
      dealDamage(botAttacker, target, vc);
      log('--- FINE TURNO BOT ---');
    }

    // ------------- Render -------------
    function renderAll() {
      renderStats();
      renderHand();
      renderMana();
    }

    function renderStats() {
      const ps = document.getElementById('playerStats');
      const bs = document.getElementById('botStats');

      const fmtChar = (c) =>
        `${c.name}
LP: ${c.lp}
ATK: ${c.atk}   DEF: ${c.def}`;

      ps.textContent = playerChars.map(fmtChar).join('\n\n');
      bs.textContent = botChars.map(fmtChar).join('\n\n');
    }

    function renderHand() {
      const handEl = document.getElementById('playerHand');
      handEl.innerHTML = '';
      playerHand.forEach(card => {
        const div = document.createElement('div');
        div.className = 'card';
        if (selectedCardIds.includes(card.id)) div.classList.add('selected');
        div.onclick = () => toggleCardSelection(card.id);

        const header = document.createElement('div');
        header.className = 'card-header';
        header.textContent = card.name;

        const cost = document.createElement('div');
        cost.className = 'card-cost';
        cost.textContent = `Costo: ${card.cost} mana`;

        const body = document.createElement('div');
        body.className = 'card-body';
        body.textContent = card.text;

        div.appendChild(header);
        div.appendChild(cost);
        div.appendChild(body);
        handEl.appendChild(div);
      });
    }

    function renderMana() {
      const manaEl = document.getElementById('manaInfo');
      const totalSelectedCost = selectedCardIds
        .map(id => playerHand.find(c => c.id === id)?.cost ?? 0)
        .reduce((a, b) => a + b, 0);
      manaEl.textContent =
        `Mana turno: ${manaAtTurnStart}  |  Costo carte selezionate: ${totalSelectedCost}  |  Mana residuo dopo risoluzione: ${manaAtTurnStart - totalSelectedCost}`;
    }

    // ------------- Event listeners -------------
    document.getElementById('startTurnBtn').addEventListener('click', startPlayerTurn);
    document.getElementById('resolveBtn').addEventListener('click', resolveTurn);
    document.getElementById('resetTurnBtn').addEventListener('click', resetTurnSelection);

    // Avvio
    initGame();
  </script>
</body>
</html>
