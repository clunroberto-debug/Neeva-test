<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Test Critico - Neeva</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
      padding: 12px;
    }
    h1 {
      font-size: 18px;
      margin: 0 0 8px;
    }
    .row {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }
    .card {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px;
      background: #030712;
      font-size: 13px;
      flex: 1;
    }
    .card h2 {
      font-size: 14px;
      margin: 0 0 6px;
    }
    button {
      font-family: inherit;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      background: #22c55e;
      color: #020617;
      font-weight: 600;
      margin-right: 8px;
    }
    button.secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #1f2937;
    }
    #log {
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 8px;
      font-size: 12px;
      max-height: 280px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .line-system { color: #9ca3af; }
    .line-hit { color: #22c55e; }
    .line-crit { color: #f97316; }
  </style>
</head>
<body>
  <h1>Test Critico 1 vs 1 (VC &amp; CRIT_DMG)</h1>

  <div class="row">
    <div class="card" id="att-card">
      <h2>Attaccante</h2>
      <div id="att-stats"></div>
    </div>
    <div class="card" id="def-card">
      <h2>Difensore</h2>
      <div id="def-stats"></div>
    </div>
  </div>

  <div class="card">
    <h2>Carta di test</h2>
    <p><strong>Nome:</strong> Colpo di Prova</p>
    <p><strong>VC:</strong> <span id="vc-span">120</span>% ATK</p>
    <p>
      <button id="btn-attack">Attacca (con tiro critico)</button>
      <button id="btn-force-crit" class="secondary">Attacca (critico forzato)</button>
    </p>
  </div>

  <div id="log"></div>

  <script>
    /************* Utils *************/
    function log(msg, type = "system") {
      const logEl = document.getElementById("log");
      const line = document.createElement("div");
      if (type === "system") line.className = "line-system";
      else if (type === "hit") line.className = "line-hit";
      else if (type === "crit") line.className = "line-crit";
      line.textContent = msg;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    /************* Dati *************/
    const attacker = {
      name: "Lariat (test)",
      HP: 999,
      ATK: 100,
      DEF: 20,
      CRIT_CHANCE: 100, // 100% per vedere SEMPRE il crit con tiro
      CRIT_RESIST: 0,
      CRIT_DMG: 150,    // 150% dell'ATK_carta in caso di crit
      CRIT_DEF: 10      // NON usata per l'attaccante, solo per quando è difensore
    };

    const defender = {
      name: "Dummy",
      HP: 1000,
      ATK: 50,
      DEF: 30,
      CRIT_CHANCE: 0,
      CRIT_RESIST: 0,
      CRIT_DMG: 0,
      CRIT_DEF: 20      // riduce il danno crit
    };

    const VC = 120; // Valore Carta di prova (120% ATK)

    function renderStats() {
      const attDiv = document.getElementById("att-stats");
      const defDiv = document.getElementById("def-stats");

      attDiv.innerHTML =
        `HP: ${attacker.HP}<br>` +
        `ATK: ${attacker.ATK} | DEF: ${attacker.DEF}<br>` +
        `CRIT_CHANCE: ${attacker.CRIT_CHANCE}%<br>` +
        `CRIT_RESIST: ${attacker.CRIT_RESIST}%<br>` +
        `CRIT_DMG: ${attacker.CRIT_DMG}%<br>` +
        `CRIT_DEF: ${attacker.CRIT_DEF}`;

      defDiv.innerHTML =
        `HP: ${defender.HP}<br>` +
        `ATK: ${defender.ATK} | DEF: ${defender.DEF}<br>` +
        `CRIT_CHANCE: ${defender.CRIT_CHANCE}%<br>` +
        `CRIT_RESIST: ${defender.CRIT_RESIST}%<br>` +
        `CRIT_DMG: ${defender.CRIT_DMG}%<br>` +
        `CRIT_DEF: ${defender.CRIT_DEF}`;
    }

    /************* Formula di danno *************/
    // ESATTAMENTE come definito:
    // ATK_carta = ATK_att * (VC/100)
    // Prova critico:
    //   CritChanceEff = CRIT_CHANCE_att - CRIT_RESIST_dif (clamp 0-100)
    //   tiro d100: se <= CritChanceEff -> crit
    // Se NON crit:
    //   Danno = ATK_carta - DEF_dif
    // Se crit:
    //   DannoCrit_att = ATK_carta * (CRIT_DMG_att / 100)
    //   Danno = DannoCrit_att - CRIT_DEF_dif
    function calculateDamage(att, def, VC, forceCrit = false) {
      const vcFactor = VC / 100;
      const atkCard = att.ATK * vcFactor;

      let critChanceEff = att.CRIT_CHANCE - def.CRIT_RESIST;
      if (critChanceEff < 0) critChanceEff = 0;
      if (critChanceEff > 100) critChanceEff = 100;

      let roll = null;
      let isCrit = false;

      if (forceCrit) {
        isCrit = true;
      } else if (critChanceEff > 0) {
        roll = randomInt(1, 100);
        if (roll <= critChanceEff) {
          isCrit = true;
        }
      }

      if (!isCrit) {
        const rawNormal = atkCard - def.DEF;
        const dmg = Math.max(0, Math.round(rawNormal));
        return {
          damage: dmg,
          isCrit: false,
          roll,
          critChanceEff,
          atkCard,
          rawNormal,
          critRawAtt: null,
          critAfterDef: null
        };
      }

      const critFactor = att.CRIT_DMG / 100;
      const critRawAtt = atkCard * critFactor;
      const critAfterDef = critRawAtt - def.CRIT_DEF;
      const dmg = Math.max(0, Math.round(critAfterDef));

      return {
        damage: dmg,
        isCrit: true,
        roll,
        critChanceEff,
        atkCard,
        rawNormal: null,
        critRawAtt,
        critAfterDef
      };
    }

    function doAttack(forceCrit = false) {
      log("────────────────────────────────", "system");
      log(`Attaccante: ${attacker.name}`, "system");
      log(`Difensore: ${defender.name}`, "system");
      log(`VC carta = ${VC}%`, "system");

      const res = calculateDamage(attacker, defender, VC, forceCrit);
      defender.HP = Math.max(0, defender.HP - res.damage);

      // riepilogo
      const tag = res.isCrit ? "CRITICO" : "normale";
      log(
        `Risultato attacco: ${res.damage} danni (${tag})`,
        res.isCrit ? "crit" : "hit"
      );

      // dettagli critico
      const rollText = res.roll === null ? "n/a" : res.roll;
      log(
        `CritChanceEff = ${res.critChanceEff}%  | tiro d100 = ${rollText}`,
        "system"
      );

      // ATK carta
      log(
        `ATK_carta = ATK (${attacker.ATK}) x VC (${VC}%) = ${res.atkCard.toFixed(2)}`,
        "system"
      );

      if (!res.isCrit) {
        log(
          `Danno normale: ATK_carta (${res.atkCard.toFixed(2)}) - DEF (${defender.DEF}) = ` +
          `${res.rawNormal.toFixed(2)} → ${res.damage}`,
          "system"
        );
      } else {
        log(
          `Danno crit (prima di CRIT_DEF): ATK_carta (${res.atkCard.toFixed(2)}) x CRIT_DMG (${attacker.CRIT_DMG}%) = ` +
          `${res.critRawAtt.toFixed(2)}`,
          "system"
        );
        log(
          `Applico CRIT_DEF (${defender.CRIT_DEF}): ${res.critRawAtt.toFixed(2)} - ${defender.CRIT_DEF} = ` +
          `${res.critAfterDef.toFixed(2)} → ${res.damage}`,
          "system"
        );
      }

      log(
        `HP rimanenti di ${defender.name}: ${defender.HP}`,
        "system"
      );

      renderStats();
    }

    /************* Init *************/
    document.getElementById("btn-attack").addEventListener("click", () => {
      doAttack(false); // usa tiro critico normale
    });

    document.getElementById("btn-force-crit").addEventListener("click", () => {
      doAttack(true);  // forza il critico (per testare il ramo crit anche se CritChanceEff = 0)
    });

    renderStats();
    log("Pronto. Premi 'Attacca' per testare il critico.", "system");
  </script>
</body>
</html>
